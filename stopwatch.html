<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OBS Stopwatch</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: 'Segoe UI', 'Roboto Mono', 'Courier New', monospace;
    background: transparent;
    color: #00FF00;
    overflow: hidden;
    user-select: none;
  }
  
  #container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
  }
  
  #timer {
    font-size: 72px;
    font-weight: bold;
    letter-spacing: 0.05em;
    text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    margin-bottom: 20px;
  }
  
  #controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  button {
    font-size: 18px;
    padding: 10px 20px;
    background: rgba(0, 255, 0, 0.1);
    border: 2px solid #00FF00;
    color: #00FF00;
    cursor: pointer;
    border-radius: 5px;
    transition: all 0.2s;
    font-family: inherit;
  }
  
  button:hover {
    background: rgba(0, 255, 0, 0.2);
    transform: translateY(-2px);
  }
  
  button:active {
    transform: translateY(0);
  }
  
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  #laps {
    margin-top: 20px;
    max-height: 200px;
    overflow-y: auto;
    font-size: 16px;
    text-align: left;
    width: 100%;
    max-width: 400px;
  }
  
  .lap-item {
    padding: 5px;
    border-bottom: 1px solid rgba(0, 255, 0, 0.2);
  }
  
  /* Display mode - hide controls */
  .display-mode #controls,
  .display-mode #laps {
    display: none;
  }
  
  .display-mode #timer {
    margin-bottom: 0;
  }
</style>
</head>
<body>
<div id="container">
  <div id="timer">00:00:00.000</div>
  <div id="controls">
    <button id="startStopBtn">Start</button>
    <button id="resetBtn">Reset</button>
    <button id="lapBtn">Lap</button>
  </div>
  <div id="laps"></div>
</div>

<script>
// Stopwatch logic
class Stopwatch {
  constructor() {
    this.startTime = 0;
    this.elapsedTime = 0;
    this.isRunning = false;
    this.laps = [];
    this.tick = this.tick.bind(this);
    this.loadState();
  }
  
  formatTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    const milliseconds = ms % 1000;
    
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(3, '0')}`;
  }
  
  updateDisplay() {
    const display = document.getElementById('timer');
    display.textContent = this.formatTime(this.elapsedTime);
  }
  
  start() {
    if (!this.isRunning) {
      this.startTime = Date.now() - this.elapsedTime;
      this.isRunning = true;
      requestAnimationFrame(this.tick);
      this.saveState();
      this.updateButtons();
    }
  }
  
  stop() {
    if (this.isRunning) {
      this.isRunning = false;
      this.saveState();
      this.updateButtons();
    }
  }
  
  reset() {
    this.isRunning = false;
    this.elapsedTime = 0;
    this.laps = [];
    this.saveState();
    this.updateDisplay();
    this.updateButtons();
    this.updateLaps();
  }
  
  lap() {
    if (this.isRunning) {
      this.laps.push(this.elapsedTime);
      this.saveState();
      this.updateLaps();
    }
  }
  
  tick() {
    if (this.isRunning) {
      this.elapsedTime = Date.now() - this.startTime;
      this.updateDisplay();
      requestAnimationFrame(this.tick);
    }
  }
  
  updateButtons() {
    const startStopBtn = document.getElementById('startStopBtn');
    if (this.isRunning) {
      startStopBtn.textContent = 'Stop';
      startStopBtn.onclick = () => this.stop();
    } else {
      startStopBtn.textContent = this.elapsedTime > 0 ? 'Resume' : 'Start';
      startStopBtn.onclick = () => this.start();
    }
  }
  
  updateLaps() {
    const lapsContainer = document.getElementById('laps');
    if (this.laps.length === 0) {
      lapsContainer.innerHTML = '';
      return;
    }
    
    const lapsHtml = this.laps.map((lapTime, index) => {
      const prevTime = index === 0 ? 0 : this.laps[index - 1];
      const lapDuration = lapTime - prevTime;
      return `<div class="lap-item">Lap ${index + 1}: ${this.formatTime(lapDuration)} (Total: ${this.formatTime(lapTime)})</div>`;
    }).join('');
    
    lapsContainer.innerHTML = `<h3>Laps</h3>${lapsHtml}`;
  }
  
  saveState() {
    const state = {
      elapsedTime: this.elapsedTime,
      isRunning: this.isRunning,
      startTime: this.startTime,
      laps: this.laps,
      timestamp: Date.now()
    };
    localStorage.setItem('obsStopwatchState', JSON.stringify(state));
  }
  
  loadState() {
    const saved = localStorage.getItem('obsStopwatchState');
    if (saved) {
      const state = JSON.parse(saved);
      // Only restore if less than 1 hour old
      if (Date.now() - state.timestamp < 3600000) {
        this.laps = state.laps || [];
        if (state.isRunning) {
          // Calculate elapsed time since last save
          this.elapsedTime = state.elapsedTime + (Date.now() - state.timestamp);
          this.isRunning = false; // Don't auto-start
        } else {
          this.elapsedTime = state.elapsedTime;
          this.isRunning = false;
        }
        this.updateDisplay();
        this.updateLaps();
      }
    }
  }
  
  // Public API for external control
  command(action) {
    switch(action) {
      case 'start': this.start(); break;
      case 'stop': this.stop(); break;
      case 'reset': this.reset(); break;
      case 'lap': this.lap(); break;
      case 'toggle': this.isRunning ? this.stop() : this.start(); break;
    }
  }
}

// Initialize
const stopwatch = new Stopwatch();
stopwatch.updateButtons();

// Button bindings
document.getElementById('resetBtn').onclick = () => stopwatch.reset();
document.getElementById('lapBtn').onclick = () => stopwatch.lap();

// Check for display mode
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('display') === 'true') {
  document.body.classList.add('display-mode');
}

// Keyboard shortcuts (when interacting)
document.addEventListener('keydown', (e) => {
  if (e.code === 'Space') {
    e.preventDefault();
    stopwatch.command('toggle');
  } else if (e.code === 'KeyR') {
    stopwatch.reset();
  } else if (e.code === 'KeyL') {
    stopwatch.lap();
  }
});

// Expose to window for external control (e.g., from OBS JavaScript)
window.stopwatchAPI = {
  start: () => stopwatch.start(),
  stop: () => stopwatch.stop(),
  reset: () => stopwatch.reset(),
  lap: () => stopwatch.lap(),
  toggle: () => stopwatch.command('toggle')
};
</script>
</body>
</html>
